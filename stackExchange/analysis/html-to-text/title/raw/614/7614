Testing a function that throws on failure